#========================================================
# Leapfrog Bolt Pro - Klipper Configuration
# Mainboard: ATmega2560 (LMC V2)
# Firmware: Klipper
# Notes:
# - Dual independent X-axis (IDEX)
# - E0 = Right Extruder (X0)
# - E1 = Left Extruder (X1)
#========================================================

[include mainsail.cfg]
[include macros.cfg]

#####################################################################
# System and Basic Settings
#####################################################################
[respond]

[virtual_sdcard]
path: ~/printer_data/gcodes

#####################################################################
# MCU / Printer Basics
#####################################################################
[mcu]
serial: /dev/serial/by-id/usb-FTDI_FT232R_USB_UART_AL03EL2W-if00-port0
baud: 250000
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 200
max_accel: 1000
max_z_velocity: 5
max_z_accel: 100
square_corner_velocity: 5.0


#####################################################################
# ADC PT100 Calibration    
#####################################################################
#[adc_temperature pt100_leapfrog]
#temperature1: 0
#voltage1: 1.95
#temperature2: 100
#voltage2: 2.68
#temperature3: 200
#voltage3: 3.77
#temperature4: 300
#voltage4: 4.05
#temperature5: 400
#voltage5: 4.68               The original that matches the original Marlin firmware


[adc_temperature pt100_leapfrog]
# Derived from Leapfrog's Marlin PT100 ADC table (5V, 10-bit), converted to volts
temperature1: 0
voltage1: 1.955
temperature2: 50
voltage2: 2.322
temperature3: 100
voltage3: 2.683
temperature4: 140
voltage4: 2.967
temperature5: 170
voltage5: 3.177
temperature6: 200
voltage6: 3.382
temperature7: 220
voltage7: 3.519
temperature8: 240
voltage8: 3.651
temperature9: 255
voltage9: 3.749
temperature10: 270
voltage10: 3.851



#####################################################################
# Stepper Drivers / Endstops - Dual Independent Carriages
#####################################################################

#------------------------------------------------------
# Right X Carriage (E0)
#------------------------------------------------------
[stepper_x]
step_pin: PA6
dir_pin: PK1
enable_pin: !PA7
rotation_distance: 24
microsteps: 16
endstop_pin: ^PL4       # Right X endstop (X0_MAX)
position_endstop: 339
position_max: 339
position_min: -37
homing_speed: 50


#------------------------------------------------------
# Left X Carriage (E1)
#------------------------------------------------------
#[stepper_x1]
#step_pin: PJ1         # X1_STEP_PIN = D14 -> PJ1
#dir_pin:  PJ0        # X1_DIR_PIN = D15 -> PJ0, inverted per Marlin
#enable_pin: !PG2      # X1_ENABLE_PIN = D39 -> PG2 (active-low)
#endstop_pin: ^PL2     # X1_MIN = D47 -> PL2
#rotation_distance: 40
#microsteps: 16
#------------------------------------------------------
# Dual Carriage (IDEX mode)
#------------------------------------------------------
[dual_carriage]
axis: x
step_pin: PJ1         # X1_STEP_PIN = D14 -> PJ1
dir_pin:  !PJ0        # X1_DIR_PIN = D15 -> PJ0, inverted per Marlin
enable_pin: !PG2      # X1_ENABLE_PIN = D39 -> PG2 (active-low)
rotation_distance: 24
microsteps: 16
endstop_pin: ^PL2     # X1_MIN = D47 -> PL2
position_endstop: -37
position_min: -37
position_max: 339
homing_speed: 50

#------------------------------------------------------
# Y Axis
#------------------------------------------------------
[stepper_y]
step_pin: PK3
dir_pin: !PK2
enable_pin: !PK4
rotation_distance: 30
microsteps: 16
endstop_pin: ^PL1        # Y max endstop
position_endstop: 322
position_max: 322
position_min: -33
homing_speed: 50
homing_positive_dir: true

#------------------------------------------------------
# Z Axis (no inversion needed)
#------------------------------------------------------
[stepper_z] #otend in th
step_pin: PC6
dir_pin: PC5
enable_pin: !PC7
rotation_distance: 1.667
microsteps: 16
endstop_pin: ^!PL0       # Z min endstop
position_endstop: 0
position_max: 205
homing_speed: 5


#####################################################################
# Extruder 0 (Right Head)
#####################################################################
[extruder]
# ...
#control: watermark   # <â€” temporarily
max_extrude_only_distance: 100
step_pin: PC3
dir_pin: PC2
enable_pin: !PC4
rotation_distance: 16.099
full_steps_per_rotation: 200
microsteps: 16
heater_pin: PH6
sensor_type: pt100_leapfrog
sensor_pin: PK5
#control: pid
#pid_Kp: 22.787
#pid_Ki: 0.687
#pid_Kd: 188.846
min_temp: 0
max_temp: 270
nozzle_diameter: 0.35
filament_diameter: 1.75

[verify_heater extruder]
max_error: 300
check_gain_time: 300
hysteresis: 10
heating_gain: 0.5

#####################################################################
# Extruder 1 (Left Head)
#####################################################################
[extruder1]
max_extrude_only_distance: 100
step_pin: PC0
dir_pin: !PG1          # was PC1 (wrong)
enable_pin: !PC1      # was !PG5 / !PC7 (wrong)
rotation_distance: 16.099
full_steps_per_rotation: 200
microsteps: 16
heater_pin: PH5
sensor_type: pt100_leapfrog
sensor_pin: PK7
#control: pid
#pid_Kp: 22.787
#pid_Ki: 0.687
#pid_Kd: 188.846
min_temp: 0
max_temp: 270
nozzle_diameter: 0.35
filament_diameter: 1.75


[verify_heater extruder1]
max_error: 300
check_gain_time: 300
hysteresis: 10
heating_gain: 0.5

#####################################################################
# Heated Bed
#####################################################################
[heater_bed]
heater_pin: PB4
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PK6
#control: pid
#pid_Kp: 64.388
#pid_Ki: 1.199
#pid_Kd: 864.408
min_temp: 0
max_temp: 110

#####################################################################
# Cooling Fans
#####################################################################
[fan]
pin: PE3                # Part cooling fan

#[heater_fan hotend_cooling_fan]
#pin: PE4                # Hotend cooling fan
#max_power: 1.0
#kick_start_time: 0.5
#heater: extruder
#heater_temp: 50.0

#####################################################################
# Idle and Safety
#####################################################################
[idle_timeout]
timeout: 600

# ============================================================
# Add LED state calls to main macros
# ============================================================
[gcode_shell_command led_idle]
command: python3 /home/pi/leapfrog/led_control/led_state.py idle
timeout: 2
verbose: True

[gcode_shell_command led_printing]
command: python3 /home/pi/leapfrog/led_control/led_state.py printing
timeout: 2
verbose: True

[gcode_shell_command led_success]
command: python3 /home/pi/leapfrog/led_control/led_state.py success
timeout: 60
verbose: True

[gcode_shell_command led_error]
command: python3 /home/pi/leapfrog/led_control/led_state.py error
timeout: 60
verbose: True

[gcode_macro PRINT_START]
gcode:
    LED_PRINTING
    G28
    ; your other start commands

[gcode_macro PRINT_END]
gcode:
    LED_SUCCESS
    M84

[gcode_macro PRINT_CANCEL]
gcode:
    LED_ERROR

[gcode_shell_command test_shell]
command: echo "Shell command works!"
timeout: 2
verbose: True

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder1]
#*# control = pid
#*# pid_kp = 36.287
#*# pid_ki = 1.551
#*# pid_kd = 212.280
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 33.767
#*# pid_ki = 1.301
#*# pid_kd = 219.064
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 61.913
#*# pid_ki = 1.034
#*# pid_kd = 926.377
